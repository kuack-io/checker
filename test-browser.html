<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuack Checker Browser Test</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: #05060a;
            --bg-muted: #0b0d16;
            --panel: #121627;
            --panel-muted: #1a1f35;
            --text: #f4f7ff;
            --text-muted: #96a0c1;
            --accent: #5ef1ff;
            --accent-strong: #29c1ff;
            --warning: #ffb347;
            --error: #ff6b6b;
            --success: #4ade80;
            --shadow: 0 25px 60px rgba(0, 0, 0, 0.55);
            --radius: 16px;
            font-family: 'Inter', 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            padding: 48px 16px 72px;
            background: radial-gradient(circle at top, #0f172a, var(--bg) 55%);
            color: var(--text);
            display: flex;
            justify-content: center;
        }

        main {
            width: min(960px, 100%);
        }

        .app-shell {
            background: var(--panel);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        h1 {
            font-size: clamp(1.8rem, 3vw, 2.6rem);
            margin: 0 0 12px;
            letter-spacing: 0.02em;
        }

        p.lead {
            color: var(--text-muted);
            margin: 0 0 28px;
            max-width: 640px;
        }

        .card-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 32px;
        }

        .card {
            padding: 18px 20px;
            background: var(--panel-muted);
            border-radius: calc(var(--radius) / 1.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card strong {
            display: block;
            margin-bottom: 6px;
            color: var(--accent);
            letter-spacing: 0.08em;
            font-size: 0.78rem;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
        }

        input[type="text"] {
            flex: 1;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
            color: var(--text);
            padding: 14px 16px;
            border-radius: calc(var(--radius) / 2);
            font-size: 1rem;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(94, 241, 255, 0.15);
        }

        button {
            border: none;
            border-radius: calc(var(--radius) / 2);
            padding: 14px 28px;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(120deg, var(--accent), var(--accent-strong));
            color: #020205;
            cursor: pointer;
            transition: transform 180ms ease, box-shadow 180ms ease, filter 180ms ease;
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 30px rgba(41, 193, 255, 0.35);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        #output {
            margin-top: 32px;
            padding: 24px;
            background: #0c111f;
            border-radius: calc(var(--radius) * 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 140px;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .status--success {
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
        }

        .status--failure {
            background: rgba(255, 107, 107, 0.15);
            color: var(--error);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.02);
            border-radius: calc(var(--radius) / 1.5);
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .metric-card h4 {
            margin: 0 0 6px;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .metric-card p {
            margin: 0;
            font-size: 1.4rem;
            word-break: break-all;
        }

        .notice {
            padding: 14px 18px;
            border-radius: calc(var(--radius) / 1.5);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--text);
            line-height: 1.6;
        }

        .notice--success { border-color: rgba(74, 222, 128, 0.4); }
        .notice--warning { border-color: rgba(255, 179, 71, 0.4); color: var(--warning); }
        .notice--error { border-color: rgba(255, 107, 107, 0.4); color: var(--error); }
        .notice--muted { color: var(--text-muted); }

        pre {
            margin: 0;
            background: rgba(0, 0, 0, 0.45);
            border-radius: calc(var(--radius) / 2);
            padding: 16px;
            font-size: 0.9rem;
            overflow-x: auto;
        }

        .fine-print {
            margin-top: 12px;
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        @media (max-width: 640px) {
            .app-shell { padding: 28px 20px; }
            .input-row { flex-direction: column; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <main>
        <section class="app-shell">
            <h1>Kuack Checker WASM</h1>
            <p class="lead">Measure HTTP endpoints directly from the browser, the same way the native and WASI builds do</p>

            <div class="card-grid">
                <article class="card">
                    <strong>Platform Agnostic</strong>
                    Identical Rust business logic ships to Linux, WASM, and WASI targets.
                </article>
                <article class="card">
                    <strong>CORS Notice</strong>
                    Remote servers must allow cross-origin requests; same-origin URLs work out of the box.
                </article>
            </div>

            <label for="url">Target URL</label>
            <div class="input-row">
                <input
                    type="text"
                    id="url"
                    value="https://kuack.io"
                    placeholder="https://kuack.io"
                    autocomplete="url"
                />
                <button id="checkBtn">Check Endpoint</button>
            </div>

            <div id="output" class="notice notice--muted">
                Initializing WebAssembly module...
            </div>
        </section>
    </main>

    <script type="module">
        import init, { check_endpoint, main } from './pkg/kuack_checker.js';

        // Expose main for manual testing in console
        window.runAgentMain = async (url) => {
            console.log('Running agent main function...');
            try {
                await main({ TARGET_URL: url || 'https://kuack.io' });
                console.log('Agent main finished successfully');
            } catch (e) {
                console.error('Agent main failed:', e);
            }
        };

        const output = document.getElementById('output');
        const checkBtn = document.getElementById('checkBtn');
        const urlInput = document.getElementById('url');

        const setOutput = (content) => {
            output.innerHTML = content;
        };

        const renderMetrics = (metrics, jsOverhead) => `
            <div class="status status--${metrics.success ? 'success' : 'failure'}">
                ${metrics.success ? 'Success' : 'Failed'}
            </div>
            <div class="metrics-grid">
                <article class="metric-card">
                    <h4>URL</h4>
                    <p>${metrics.url}</p>
                </article>
                <article class="metric-card">
                    <h4>Total Time</h4>
                    <p>${metrics.total_time_ms.toFixed(2)} ms</p>
                </article>
            </div>
            <section class="json-block">
                <h4>Full JSON Output</h4>
                <pre>${JSON.stringify(metrics, null, 2)}</pre>
            </section>
            <p class="fine-print">JavaScript overhead: ${jsOverhead.toFixed(2)} ms</p>
        `;

        const renderError = (title, message, details = '') => `
            <div class="notice notice--error">
                <strong>${title}</strong>
                <p>${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            </div>
        `;

        const handleCheck = async () => {
            const url = urlInput.value.trim();
            if (!url) {
                setOutput('<div class="notice notice--warning">Please provide a URL to test</div>');
                return;
            }

            checkBtn.disabled = true;
            setOutput('<div class="notice notice--muted">Checking endpoint...</div>');

            try {
                const start = performance.now();
                const metrics = await check_endpoint(url);
                const end = performance.now();
                const jsOverhead = end - start - metrics.total_time_ms;
                setOutput(renderMetrics(metrics, jsOverhead));
            } catch (error) {
                console.error('Error during check:', error);
                setOutput(renderError('Request Failed', error.message, error.stack || error));
            } finally {
                checkBtn.disabled = false;
            }
        };

        checkBtn.addEventListener('click', handleCheck);

        (async () => {
            try {
                await init();
                console.log('WASM module initialized successfully');
                setOutput('<div class="notice notice--success">WASM module ready. Enter a URL to begin.</div>');
            } catch (error) {
                console.error('Failed to initialize WASM:', error);
                setOutput(renderError('Initialization Failed', error.message));
                checkBtn.disabled = true;
            }
        })();
    </script>
</body>
</html>
