name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  merge_group:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0 # prevent incremental build artifacts from bloating cache/time
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse # faster sparse registry updates

jobs:
  pre-commit:
    name: Pre-commit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main') # runs on main to update the cache used in PRs
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: '.pre-commit-config.yaml'
      - name: Cache pre-commit
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1

  install-deps:
    name: Install Dependencies
    runs-on: ubuntu-latest # runs in PRs, merge queues and on main
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "debug-build"
      - name: Build dependencies
        run: cargo build --all-targets --all-features

  fmt:
    name: Format
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          components: rustfmt
      - name: Run fmt check
        run: cargo fmt --all --check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    needs: install-deps
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          components: clippy
      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "debug-build"
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' # only run on PRs
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit
      - name: Run cargo audit
        run: cargo audit

  deny:
    name: Dependency Policy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' # only run on PRs
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      # cargo-deny is a standalone binary, it doesn't need a rust toolchain installed
      - name: Install cargo-deny
        uses: taiki-e/install-action@cargo-deny
      - name: Run cargo deny
        run: cargo deny check

  test:
    name: Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    needs: install-deps
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "debug-build"
      - name: Run test suite
        run: cargo test --all-features

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main') # runs on main to update the cache used in PRs
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "coverage-build" # tarpaulin recompiles binaries with extra flags, it can't share cache from install-deps job
      - name: Install cargo-tarpaulin
        uses: taiki-e/install-action@cargo-tarpaulin
      - name: Run coverage
        run: cargo tarpaulin --skip-clean --out Xml --fail-under 90 --exclude-files src/main.rs

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    needs: install-deps
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            kind: native
            artifact: kuack-checker-linux-x64
          - target: wasm32-unknown-unknown
            kind: wasm-pack
            artifact: kuack-checker-wasm
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          targets: ${{ matrix.target }}
      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "debug-build"
      - name: Install wasm-pack
        if: matrix.kind == 'wasm-pack'
        uses: taiki-e/install-action@wasm-pack
      - name: Prepare dist directory
        run: |
          rm -rf dist
          mkdir -p dist
      - name: Build release artifacts
        run: |
          set -euo pipefail
          rustup target add ${{ matrix.target }}
          if [ "${{ matrix.kind }}" = "native" ]; then
            cargo build --release --target ${{ matrix.target }}
            strip target/x86_64-unknown-linux-gnu/release/kuack-checker
            cp target/x86_64-unknown-linux-gnu/release/kuack-checker dist/kuack-checker
          else
            wasm-pack build --release --target web
            rm -rf dist/pkg
            cp -R pkg dist/pkg
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: dist

  ci-passed:
    name: CI Passed
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request' # only run on PRs
    needs: [pre-commit, fmt, lint, audit, deny, test, coverage, build-check]
    steps:
      - name: Check status of all required jobs
        run: |
          echo "Results: ${{ toJson(needs) }}"
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'skipped') }}" == "true" ]]; then
            echo "One or more jobs were skipped, but strictly required"
            exit 1
          fi
          echo "All required checks passed"
